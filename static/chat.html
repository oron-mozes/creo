<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Creo</title>
    <meta name="description" content="Chat with Creo AI to find the perfect influencers for your business">
    <link rel="icon" type="image/png" href="/static/creo-logo-BesatB3H.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- GSAP for animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- Auth utilities must be loaded first -->
    <script src="/static/auth-utils.js"></script>
    <script src="/static/user-utils.js"></script>
    <script src="/static/auth-gate.js"></script>
    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }

        /* Auto-grow textarea */
        #messageInput {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Typing indicator animation */
        @keyframes typing-dot {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgb(0, 160, 235);
            display: inline-block;
            animation: typing-dot 1.4s infinite;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>

<body class="min-h-screen bg-white">
    <!-- Header -->
    <header class="border-b bg-white/95 backdrop-blur-sm sticky top-0 z-10">
        <div class="px-4 py-2">
            <div class="flex items-center justify-between">
                <a href="/" class="pl-2">
                    <img src="/static/creo-logo-BesatB3H.png" alt="Creo" style="height: 3rem;">
                </a>

                <!-- User Profile -->
                <div id="userProfile" class="hidden flex items-center gap-3 pr-4">
                    <span id="userName" class="text-sm font-medium text-gray-700"></span>
                    <div class="relative">
                        <button onclick="toggleUserMenu()" id="userAvatar" class="flex items-center justify-center h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 text-white font-semibold text-sm">
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 py-1 z-50">
                            <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div id="chat-main-layout" class="flex h-[calc(100vh-4rem)]">
        <!-- Chat Area -->
        <main id="chat-main-area" class="flex-1 flex flex-col">
            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto px-6 py-8">
                <div id="chat-messages-wrapper" class="max-w-4xl mx-auto space-y-4">
                    <div id="messages">
                    <!-- Loading indicator -->
                    <div id="loadingIndicator" class="flex gap-4 animate-fade-in">
                        <div class="flex gap-3 items-start max-w-[85%]">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full text-white"
                                style="background: linear-gradient(135deg, rgb(0, 160, 235), rgb(0, 144, 211));">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div
                                class="flex-1 p-4 rounded-2xl text-base bg-white border border-gray-200 flex items-center gap-2">
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area (Fixed at bottom) -->
            <div id="chat-input-container" class="bg-white">
                <div class="max-w-4xl mx-auto px-6 py-4">
                    <div id="chat-input-area" class="bg-white p-5 shadow-2xl border-2 border-gray-200 rounded-3xl">
                        <div class="flex gap-4 items-end">
                            <textarea id="messageInput" rows="1"
                                class="flex-1 resize-none text-base border-0 focus:ring-0 focus:outline-none p-3 rounded-lg"
                                placeholder="Type here... (e.g., 'I have a small bakery in Manchester')"></textarea>
                            <button id="sendButton" onclick="sendMessage()"
                                class="inline-flex items-center justify-center gap-2 text-white px-6 py-4 rounded-2xl font-medium transition-all shrink-0"
                                style="background-color: rgba(0, 160, 235, 0.4);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-send h-5 w-5">
                                    <path
                                        d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z">
                                    </path>
                                    <path d="m21.854 2.147-10.94 10.939"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar (Quick Start & Tips) -->
        <aside id="chat-right-sidebar" class="hidden lg:flex w-80 flex-col p-6 space-y-6 overflow-y-auto">
            <!-- Quick Start Section -->
            <div id="chat-past-chats-card" class="bg-white p-6 border border-gray-200 rounded-3xl shadow-sm animate-fade-in">
                <h3 class="font-semibold mb-5 flex items-center gap-2 text-lg">
                    <svg class="h-5 w-5" style="color: rgb(0, 160, 235);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <span style="color: rgb(0, 160, 235);">Past Chats</span>
                </h3>
                <p class="text-sm text-gray-600 mb-4">Click to continue:</p>
                <div id="quickStartButtons" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Will be populated by loadQuickStartButtons() -->
                </div>
            </div>

            <!-- Helpful Tips Section -->
            <div id="chat-helpful-tips-card" class="p-6 rounded-3xl border shadow-sm animate-fade-in" style="background-color: rgba(0, 160, 235, 0.05); border-color: rgba(0, 160, 235, 0.15);">
                <h3 class="font-semibold mb-4 flex items-center gap-2 text-lg">
                    <svg class="h-5 w-5" style="color: rgb(0, 160, 235);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    <span style="color: rgb(0, 160, 235);">Helpful Tips</span>
                </h3>
                <ul class="space-y-3 text-base text-gray-700">
                    <li class="flex items-start gap-2">
                        <span style="color: rgb(0, 160, 235);" class="mt-0.5">âœ“</span>
                        <span>Share what you sell</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span style="color: rgb(0, 160, 235);" class="mt-0.5">âœ“</span>
                        <span>Tell me where you're located</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span style="color: rgb(0, 160, 235);" class="mt-0.5">âœ“</span>
                        <span>Mention your budget if you know it</span>
                    </li>
                </ul>
            </div>
        </aside>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        // Socket.IO connection
        let socket = null;
        let currentLoadingDiv = null;
        let currentResponseDiv = null;
        let currentMessageId = null;
        let currentUser = null;

        // Authentication functions
        function getAuthToken() {
            return localStorage.getItem('creo_auth_token');
        }

        function clearAuthToken() {
            localStorage.removeItem('creo_auth_token');
            localStorage.removeItem('creo_user_info');
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            if (!token) return {};
            return {
                'Authorization': `Bearer ${token}`
            };
        }

        async function checkAuthForChat() {
            // Check if user is authenticated
            const user = await checkAuth({
                requireAuth: false,  // Don't force login for chat (anonymous allowed)
                onSuccess: (user) => {
                    console.log('[CHAT] Authenticated user:', user);
                    currentUser = user;
                    displayUserProfile(user);
                    // Check if this user just registered
                    migrateAnonymousUser();
                },
                onFailure: () => {
                    console.log('[CHAT] Anonymous user');
                    displayLoginButton();
                    // Ensure anonymous user ID is generated
                    const anonId = getAnonymousUserId();
                    console.log('[CHAT] Anonymous user ID:', anonId);
                    currentUser = null;
                }
            });

            return user;
        }

        function displayUserProfile(user) {
            const userProfile = document.getElementById('userProfile');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');

            if (userProfile && userName && userAvatar) {
                userProfile.classList.remove('hidden');
                userName.textContent = user.name || user.email;

                // Set avatar (initials or image)
                if (user.picture) {
                    userAvatar.innerHTML = `<img src="${user.picture}" alt="${user.name}" class="h-10 w-10 rounded-full">`;
                } else {
                    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : user.email[0].toUpperCase();
                    userAvatar.textContent = initials;
                }
            }
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (e) {
                console.warn('Logout failed, clearing client state anyway', e);
            }
            clearAuthToken();
            window.location.href = '/login.html';
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function (event) {
            const userMenu = document.getElementById('userMenu');
            const userAvatar = document.getElementById('userAvatar');
            if (userMenu && userAvatar && !userMenu.contains(event.target) && !userAvatar.contains(event.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // Get session ID from URL
        function getSessionId() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1] || generateSessionId();
        }

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        // Load sessions from localStorage (not used - no left sidebar)
        function loadSessions() {
            // Removed - no left sidebar in current design
        }

        // Save session to localStorage
        function saveSession(sessionId, title) {
            const sessions = JSON.parse(localStorage.getItem('creo_sessions') || '[]');
            const existingIndex = sessions.findIndex(s => s.id === sessionId);

            const session = {
                id: sessionId,
                title: title || 'New Chat',
                timestamp: Date.now()
            };

            if (existingIndex >= 0) {
                sessions[existingIndex] = session;
            } else {
                sessions.unshift(session);
            }

            // Keep only last 50 sessions
            if (sessions.length > 50) sessions.length = 50;

            localStorage.setItem('creo_sessions', JSON.stringify(sessions));
            // Update right sidebar if needed
            loadQuickStartButtons();
        }

        function createNewSession() {
            const newSessionId = generateSessionId();
            window.location.href = '/chat/' + newSessionId;
        }

        async function loadSuggestionsForNewChat() {
            // Show simple welcome message in main chat area
            const messagesDiv = document.getElementById('messages');
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'flex gap-4 p-5 rounded-3xl animate-fade-in transition-all mr-12 md:mr-20';
            welcomeDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            welcomeDiv.style.backdropFilter = 'blur(4px)';
            welcomeDiv.style.border = '1px solid rgba(229, 231, 235, 0.5)';
            welcomeDiv.innerHTML = `
                <div class="flex h-11 w-11 shrink-0 items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg, rgb(0, 160, 235), rgb(0, 144, 211));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                        <path d="M12 8V4H8"></path>
                        <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                        <path d="M2 14h2"></path>
                        <path d="M20 14h2"></path>
                        <path d="M15 13v2"></path>
                        <path d="M9 13v2"></path>
                    </svg>
                </div>
                <div class="flex-1 space-y-2">
                    <p class="text-sm font-medium" style="color: rgba(31, 41, 55, 0.7);">Creo Assistant</p>
                    <div class="text-base leading-relaxed whitespace-pre-wrap" style="color: rgba(31, 41, 55, 0.9);">Hey! ðŸ‘‹ I'm here to help you connect with amazing influencers. Just tell me what you're looking for, and I'll find the perfect match for your business!</div>
                </div>
            `;
            messagesDiv.appendChild(welcomeDiv);
            scrollToBottom();

            // Populate right sidebar with past chats
            loadQuickStartButtons();
        }

        function loadQuickStartButtons() {
            const quickStartDiv = document.getElementById('quickStartButtons');
            if (!quickStartDiv) return;

            // Get past chats from localStorage
            const sessions = JSON.parse(localStorage.getItem('creo_sessions') || '[]');
            const currentSessionId = getSessionId();
            const pastChats = sessions.filter(s => s.id !== currentSessionId).slice(0, 10);

            if (pastChats.length > 0) {
                quickStartDiv.innerHTML = pastChats.map(chat => `
                    <a href="/chat/${chat.id}"
                       class="block w-full text-left p-4 text-base rounded-2xl border transition-all duration-200"
                       style="background-color: rgb(255, 255, 255); border-color: rgb(229, 231, 235);"
                       onmouseover="this.style.backgroundColor='rgba(0, 160, 235, 0.05)'; this.style.borderColor='rgba(0, 160, 235, 0.3)'; this.style.transform='scale(1.02)'"
                       onmouseout="this.style.backgroundColor='rgb(255, 255, 255)'; this.style.borderColor='rgb(229, 231, 235)'; this.style.transform='scale(1)'">
                        <div class="font-medium truncate">ðŸ’¬ ${escapeHtml(chat.title)}</div>
                        <div class="text-xs mt-1" style="color: #9CA3AF;">${new Date(chat.timestamp).toLocaleDateString()}</div>
                    </a>
                `).join('');
            } else {
                quickStartDiv.innerHTML = `
                    <button onclick="setMessageFromChip('I have a local coffee shop')"
                        class="w-full text-left p-4 text-base rounded-2xl border transition-all duration-200"
                        style="background-color: rgb(255, 255, 255); border-color: rgb(229, 231, 235);"
                        onmouseover="this.style.backgroundColor='rgba(0, 160, 235, 0.05)'; this.style.borderColor='rgba(0, 160, 235, 0.3)'; this.style.transform='scale(1.02)'"
                        onmouseout="this.style.backgroundColor='rgb(255, 255, 255)'; this.style.borderColor='rgb(229, 231, 235)'; this.style.transform='scale(1)'">
                        ðŸ’¬ I have a local coffee shop
                    </button>
                    <button onclick="setMessageFromChip('I sell handmade jewelry online')"
                        class="w-full text-left p-4 text-base rounded-2xl border transition-all duration-200"
                        style="background-color: rgb(255, 255, 255); border-color: rgb(229, 231, 235);"
                        onmouseover="this.style.backgroundColor='rgba(0, 160, 235, 0.05)'; this.style.borderColor='rgba(0, 160, 235, 0.3)'; this.style.transform='scale(1.02)'"
                        onmouseout="this.style.backgroundColor='rgb(255, 255, 255)'; this.style.borderColor='rgb(229, 231, 235)'; this.style.transform='scale(1)'">
                        ðŸ’¬ I sell handmade jewelry online
                    </button>
                    <button onclick="setMessageFromChip('I run a small gym')"
                        class="w-full text-left p-4 text-base rounded-2xl border transition-all duration-200"
                        style="background-color: rgb(255, 255, 255); border-color: rgb(229, 231, 235);"
                        onmouseover="this.style.backgroundColor='rgba(0, 160, 235, 0.05)'; this.style.borderColor='rgba(0, 160, 235, 0.3)'; this.style.transform='scale(1.02)'"
                        onmouseout="this.style.backgroundColor='rgb(255, 255, 255)'; this.style.borderColor='rgb(229, 231, 235)'; this.style.transform='scale(1)'">
                        ðŸ’¬ I run a small gym
                    </button>
                    <button onclick="setMessageFromChip('I own a boutique hotel')"
                        class="w-full text-left p-4 text-base rounded-2xl border transition-all duration-200"
                        style="background-color: rgb(255, 255, 255); border-color: rgb(229, 231, 235);"
                        onmouseover="this.style.backgroundColor='rgba(0, 160, 235, 0.05)'; this.style.borderColor='rgba(0, 160, 235, 0.3)'; this.style.transform='scale(1.02)'"
                        onmouseout="this.style.backgroundColor='rgb(255, 255, 255)'; this.style.borderColor='rgb(229, 231, 235)'; this.style.transform='scale(1)'">
                        ðŸ’¬ I own a boutique hotel
                    </button>
                `;
            }
        }

        function setMessageFromChip(text) {
            const input = document.getElementById('messageInput');
            input.value = text;
            input.focus();
            // Auto-grow textarea
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
            // Update button state
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.style.backgroundColor = 'rgb(0, 160, 235)';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function addUserMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex gap-4 p-5 rounded-3xl transition-all ml-12 md:ml-20';
            userMessageDiv.style.backgroundColor = 'rgba(0, 160, 235, 0.05)';
            userMessageDiv.innerHTML = `
                <div class="flex h-11 w-11 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground" style="background-color: rgb(0, 160, 235); color: white;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="flex-1 space-y-2">
                    <p class="text-sm font-medium" style="color: rgba(31, 41, 55, 0.7);">You</p>
                    <div class="text-base leading-relaxed whitespace-pre-wrap" style="color: rgba(31, 41, 55, 0.9);">${escapeHtml(message)}</div>
                </div>
            `;
            messagesDiv.appendChild(userMessageDiv);

            // GSAP animation: slide in from right with fade
            gsap.from(userMessageDiv, {
                opacity: 0,
                x: 30,
                duration: 0.4,
                ease: "power2.out"
            });

            scrollToBottom();
        }

        function addBotMessage(message, businessCard = null) {
            const messagesDiv = document.getElementById('messages');
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'flex gap-4 p-5 rounded-3xl transition-all mr-12 md:mr-20';
            botMessageDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            botMessageDiv.style.backdropFilter = 'blur(4px)';
            botMessageDiv.style.border = '1px solid rgba(229, 231, 235, 0.5)';

            const businessCardHtml = businessCard ? renderBusinessCard(businessCard) : '';

            botMessageDiv.innerHTML = `
                <div class="flex h-11 w-11 shrink-0 items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg, rgb(0, 160, 235), rgb(0, 144, 211));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                        <path d="M12 8V4H8"></path>
                        <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                        <path d="M2 14h2"></path>
                        <path d="M20 14h2"></path>
                        <path d="M15 13v2"></path>
                        <path d="M9 13v2"></path>
                    </svg>
                </div>
                <div class="flex-1 space-y-2">
                    <p class="text-sm font-medium" style="color: rgba(31, 41, 55, 0.7);">Creo Assistant</p>
                    <div class="text-base leading-relaxed whitespace-pre-wrap" style="color: rgba(31, 41, 55, 0.9);">
                        ${escapeHtml(message)}
                        ${businessCardHtml}
                    </div>
                </div>
            `;
            messagesDiv.appendChild(botMessageDiv);

            // GSAP animation: slide in from left with scale
            gsap.from(botMessageDiv, {
                opacity: 0,
                x: -30,
                scale: 0.95,
                duration: 0.5,
                ease: "back.out(1.2)"
            });

            scrollToBottom();
        }

        function addBotMessageWithCard(message, businessCard) {
            addBotMessage(message, businessCard);
        }

        function showLoading() {
            const messagesDiv = document.getElementById('messages');
            currentLoadingDiv = document.createElement('div');
            currentLoadingDiv.className = 'flex gap-4 p-5 rounded-3xl animate-fade-in transition-all mr-12 md:mr-20';
            currentLoadingDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            currentLoadingDiv.style.backdropFilter = 'blur(4px)';
            currentLoadingDiv.style.border = '1px solid rgba(229, 231, 235, 0.5)';
            currentLoadingDiv.innerHTML = `
                <div class="flex h-11 w-11 shrink-0 items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg, rgb(0, 160, 235), rgb(0, 144, 211));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                        <path d="M12 8V4H8"></path>
                        <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                        <path d="M2 14h2"></path>
                        <path d="M20 14h2"></path>
                        <path d="M15 13v2"></path>
                        <path d="M9 13v2"></path>
                    </svg>
                </div>
                <div class="flex-1 space-y-2">
                    <p class="text-sm font-medium" style="color: rgba(31, 41, 55, 0.7);">Creo Assistant</p>
                    <div class="text-base flex items-center gap-2">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(currentLoadingDiv);
            scrollToBottom();
        }

        function hideLoading() {
            if (currentLoadingDiv) {
                currentLoadingDiv.remove();
                currentLoadingDiv = null;
            }
            // Also search for any orphaned loading divs and remove them
            const messagesDiv = document.getElementById('messages');
            const loadingDivs = messagesDiv.querySelectorAll('.typing-dot');
            loadingDivs.forEach(div => {
                const parentDiv = div.closest('.flex.gap-4');
                if (parentDiv) {
                    parentDiv.remove();
                }
            });
        }

        function startStreamingResponse() {
            hideLoading();
            const messagesDiv = document.getElementById('messages');
            currentResponseDiv = document.createElement('div');
            currentResponseDiv.className = 'flex gap-4 p-5 rounded-3xl animate-fade-in transition-all mr-12 md:mr-20';
            currentResponseDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            currentResponseDiv.style.backdropFilter = 'blur(4px)';
            currentResponseDiv.style.border = '1px solid rgba(229, 231, 235, 0.5)';
            currentResponseDiv.innerHTML = `
                <div class="flex h-11 w-11 shrink-0 items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg, rgb(0, 160, 235), rgb(0, 144, 211));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                        <path d="M12 8V4H8"></path>
                        <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                        <path d="M2 14h2"></path>
                        <path d="M20 14h2"></path>
                        <path d="M15 13v2"></path>
                        <path d="M9 13v2"></path>
                    </svg>
                </div>
                <div class="flex-1 space-y-2">
                    <p class="text-sm font-medium" style="color: rgba(31, 41, 55, 0.7);">Creo Assistant</p>
                    <div class="response-content text-base leading-relaxed whitespace-pre-wrap" style="color: rgba(31, 41, 55, 0.9);"></div>
                </div>
            `;
            messagesDiv.appendChild(currentResponseDiv);
            scrollToBottom();
        }

        // Typewriter effect for streaming responses
        let typingQueue = [];
        let isTyping = false;

        function appendToStreamingResponse(chunk) {
            if (currentResponseDiv) {
                // Add chunk to queue
                typingQueue.push(chunk);

                // Start typing if not already typing
                if (!isTyping) {
                    typeNextChunk();
                }
            }
        }

        function typeNextChunk() {
            if (typingQueue.length === 0) {
                isTyping = false;
                return;
            }

            isTyping = true;
            const chunk = typingQueue.shift();
            const contentDiv = currentResponseDiv?.querySelector('.response-content');

            if (!contentDiv) {
                isTyping = false;
                return;
            }

            let charIndex = 0;
            const typeInterval = setInterval(() => {
                if (charIndex < chunk.length) {
                    contentDiv.textContent += chunk[charIndex];
                    charIndex++;
                    scrollToBottom();
                } else {
                    clearInterval(typeInterval);
                    // Type next chunk immediately
                    typeNextChunk();
                }
            }, 20); // 20ms per character for smooth typing
        }

        function finishStreamingResponse() {
            currentResponseDiv = null;
        }

        function simulateTyping(message, businessCard = null) {
            // Simulate typing by streaming chunks with delay
            const words = message.split(' ');
            let currentIndex = 0;
            const chunkSize = 3; // Words per chunk

            const typeNextChunk = () => {
                if (currentIndex >= words.length) {
                    // Wait for typing queue to finish before completing
                    const waitForTyping = setInterval(() => {
                        if (!isTyping && typingQueue.length === 0) {
                            clearInterval(waitForTyping);
                            // Typing complete
                            finishStreamingResponse();
                            // If there's a business card, append it
                            if (businessCard && currentResponseDiv) {
                                const contentDiv = currentResponseDiv.querySelector('.response-content');
                                if (contentDiv) {
                                    contentDiv.innerHTML += renderBusinessCard(businessCard);
                                    scrollToBottom();
                                }
                            }
                        }
                    }, 50);
                    return;
                }

                // Get next chunk of words
                const chunk = words.slice(currentIndex, currentIndex + chunkSize).join(' ') + ' ';
                appendToStreamingResponse(chunk);
                currentIndex += chunkSize;

                // Schedule next chunk (faster typing - 30ms per chunk)
                setTimeout(typeNextChunk, 30);
            };

            typeNextChunk();
        }

        function renderBusinessCard(businessCard) {
            if (!businessCard) return '';

            const formatValue = (value) => {
                return value && value !== 'Not provided' ? value : '<span class="text-gray-400 italic">Not provided</span>';
            };

            const formatWebsite = (url) => {
                if (!url || url === 'Not provided') {
                    return '<span class="text-gray-400 italic">Not provided</span>';
                }
                const displayUrl = url.replace(/^https?:\/\//, '');
                return `<a href="${url.startsWith('http') ? url : 'https://' + url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">${displayUrl}</a>`;
            };

            return `
                <div class="mt-4 p-5 rounded-xl border-2" style="background: linear-gradient(135deg, rgba(0, 160, 235, 0.05), rgba(0, 144, 211, 0.05)); border-color: rgba(0, 160, 235, 0.2);">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="h-5 w-5" style="color: rgb(0, 160, 235);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <h3 class="font-semibold text-lg" style="color: rgb(0, 160, 235);">Business Information</h3>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <div class="text-sm font-medium text-gray-600 mb-1">Business Name</div>
                            <div class="text-base">${formatValue(businessCard.name)}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-600 mb-1">Website</div>
                            <div class="text-base">${formatWebsite(businessCard.website)}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-600 mb-1">Location</div>
                            <div class="text-base">${formatValue(businessCard.location)}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-600 mb-1">Service Type</div>
                            <div class="text-base">${formatValue(businessCard.service_type)}</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600">Please confirm if this information is correct, or let me know what needs to be updated!</p>
                    </div>
                </div>
            `;
        }

        // Initialize Socket.IO
        function initializeSocket() {
            if (socket) {
                console.warn('[SOCKET] Socket already initialized, skipping');
                return;
            }

            console.log('[SOCKET] Initializing socket connection');
            socket = io();
            const sessionId = getSessionId();
            const token = getAuthToken();
            const userId = getCurrentUserId();  // Get authenticated or anonymous user ID

            console.log('[SOCKET] User ID:', userId);
            console.log('[SOCKET] Has token:', !!token);

            socket.on('connect', () => {
                console.log('[SOCKET] Connected to server');
                console.log('[SOCKET] Emitting join_session for:', sessionId);
                // Join the session room (works for both authenticated and anonymous)
                socket.emit('join_session', {
                    session_id: sessionId,
                    token: token || null,  // Include token if available
                    user_id: userId  // Always include user_id (authenticated or anonymous)
                });
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });

            socket.on('chat_history', async (data) => {
                console.log('Received chat history:', data);
                const messagesDiv = document.getElementById('messages');

                // Remove loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }

                // Display chat history
                data.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        addUserMessage(msg.content);
                    } else if (msg.role === 'assistant') {
                        addBotMessage(msg.content);
                    }
                });

                // If no messages, load suggestions for new chat
                if (data.messages.length === 0) {
                    await loadSuggestionsForNewChat();
                }
            });

            socket.on('agent_thinking', () => {
                console.log('[agent_thinking] Showing loading indicator');
                showLoading();
            });

            socket.on('message_chunk', (data) => {
                // If message_id changed, start a new response div
                if (!currentResponseDiv || (data.message_id && data.message_id !== currentMessageId)) {
                    // Finish the previous response if it exists
                    if (currentResponseDiv) {
                        finishStreamingResponse();
                    }
                    currentMessageId = data.message_id;
                    startStreamingResponse();
                }
                appendToStreamingResponse(data.chunk);
            });

            socket.on('message_complete', (data) => {
                console.log('[message_complete] Received:', data);
                console.log('[message_complete] currentResponseDiv:', currentResponseDiv);
                console.log('[message_complete] currentLoadingDiv:', currentLoadingDiv);

                finishStreamingResponse();
                hideLoading();

                console.log('[message_complete] After hideLoading, currentLoadingDiv:', currentLoadingDiv);

                // If no streaming response was active, we need to display the message
                if (!currentResponseDiv && data.message) {
                    console.log('[message_complete] Displaying non-streaming message with typing animation');
                    // Start typing animation
                    startStreamingResponse();
                    // Simulate typing with delay
                    simulateTyping(data.message, data.business_card);
                }
                // If there was a streaming response and there's a business card, append it
                else if (data.business_card && currentResponseDiv) {
                    console.log('[message_complete] Appending business card to streaming response');
                    const contentDiv = currentResponseDiv.querySelector('.response-content');
                    if (contentDiv) {
                        contentDiv.innerHTML += renderBusinessCard(data.business_card);
                        scrollToBottom();
                    }
                }

                currentMessageId = null; // Reset for next message
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data);
                hideLoading();
                finishStreamingResponse();

                // Check if it's an authentication error
                if (data.error && (data.error.includes('Authentication') || data.error.includes('Invalid') || data.error.includes('expired'))) {
                    console.error('Authentication error, redirecting to login');
                    clearAuthToken();
                    redirectToLogin();
                    return;
                }

                // Show generic error message
                const messagesDiv = document.getElementById('messages');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex gap-4 p-5 rounded-3xl bg-red-50 border border-red-200 mr-12 md:mr-20 animate-fade-in';
                errorDiv.innerHTML = `
                    <div class="flex-1 text-base text-red-700">
                        ${data.error || 'Sorry, something went wrong. Please try again.'}
                    </div>
                `;
                messagesDiv.appendChild(errorDiv);
                scrollToBottom();
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !socket) return;

            const sessionId = getSessionId();

            // Check if this is the first message in a new session
            const sessions = JSON.parse(localStorage.getItem('creo_sessions') || '[]');
            const existingSession = sessions.find(s => s.id === sessionId);
            const isFirstMessage = !existingSession;

            // Add user message to UI
            addUserMessage(message);

            // Save session with first message as title
            if (isFirstMessage) {
                const title = message.length > 50 ? message.substring(0, 50) + '...' : message;
                saveSession(sessionId, title);
            }

            // Clear input and reset height
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendButton').style.backgroundColor = 'rgba(0, 160, 235, 0.4)';

            // Show loading
            showLoading();

            // For first message in new session, create session via API first
            if (isFirstMessage) {
                try {
                    const userId = getCurrentUserId();
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({
                            message: message,
                            user_id: userId,
                            session_id: sessionId  // Use existing session ID
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create session');
                    }

                    const data = await response.json();
                    console.log('[SEND_MESSAGE] Session created:', data);
                } catch (error) {
                    console.error('[SEND_MESSAGE] Failed to create session:', error);
                    hideLoading();
                    // Show error to user
                    const messagesDiv = document.getElementById('messages');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'flex gap-4 p-5 rounded-3xl bg-red-50 border border-red-200 mr-12 md:mr-20 animate-fade-in';
                    errorDiv.innerHTML = `
                        <div class="flex-1 text-base text-red-700">
                            Sorry, failed to start the session. Please try refreshing the page.
                        </div>
                    `;
                    messagesDiv.appendChild(errorDiv);
                    scrollToBottom();
                    return;
                }
            } else {
                // For subsequent messages, send via Socket.IO
                const token = getAuthToken();
                const userId = getCurrentUserId();
                socket.emit('send_message', {
                    message: message,
                    session_id: sessionId,
                    token: token || null,
                    user_id: userId
                });
            }
        }

        // Auto-grow textarea and update button state
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        function autoGrowTextarea() {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        }

        messageInput.addEventListener('input', function () {
            // Auto-grow
            autoGrowTextarea();

            // Update button state
            if (this.value.trim()) {
                sendButton.style.backgroundColor = 'rgb(0, 160, 235)';
            } else {
                sendButton.style.backgroundColor = 'rgba(0, 160, 235, 0.4)';
            }
        });

        // Handle Enter key to send message
        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize app
        async function initializeApp() {
            // Check authentication (optional for chat - anonymous allowed)
            await checkAuthForChat();

            // Save current session if it's new (just created from homepage)
            const sessionId = getSessionId();
            const sessions = JSON.parse(localStorage.getItem('creo_sessions') || '[]');
            const existingSession = sessions.find(s => s.id === sessionId);

            if (!existingSession && sessionId) {
                // Check if we have a title from the URL (initial message from homepage)
                const urlParams = new URLSearchParams(window.location.search);
                const title = urlParams.get('title') || 'New Chat';

                // Save the new session with the title
                saveSession(sessionId, title);
                console.log('[INIT] Saved new session:', sessionId, 'with title:', title);

                // Clean up URL by removing the title parameter
                if (urlParams.has('title')) {
                    window.history.replaceState({}, '', `/chat/${sessionId}`);
                }
            }

            // Initialize socket
            initializeSocket();
            messageInput.focus();
        }

        // Start the app
        initializeApp();
    </script>
</body>

</html>
